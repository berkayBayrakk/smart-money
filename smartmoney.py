# -*- coding: utf-8 -*-
"""smartmoney.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1mJ-KBuT0f5DpWssbS1qC76ecd6XZu6Re
"""

import yfinance as yf
import pandas as pd
import numpy as np
import warnings
from datetime import datetime
import requests

# ğŸ§  AI Ã‡ekirdeÄŸi
from sklearn.linear_model import LogisticRegression
from sklearn.preprocessing import StandardScaler

# Gereksiz uyarÄ±larÄ± gizle
warnings.filterwarnings("ignore")

# ============================================================
# ğŸ›ï¸ V13: TITAN PROD CONFIGURATION (OPTIMIZED)
# ============================================================
CONFIG = {
    # --- 1. OPTÄ°MÄ°ZE EDÄ°LMÄ°Å PARAMETRELER (LAB SONUÃ‡LARI) ---
    "EMA_TREND": 20,                  # Lab sonucu: En gÃ¼venli trend
    "ATR_MULT": 2.0,                  # Lab sonucu: En ideal stop marjÄ±
    "TRAILING_PCT": 0.05,             # %5 Ä°zleyen Stop (Kar koruma)

    # --- 2. GÃœVENLÄ°K DUVARI (Safety First) ---
    "MIN_MARKET_CAP": 50_000_000_000, # 50 Milyar TL (ManipÃ¼lasyon Engeli)
    "MIN_LIQUIDITY": 100_000_000,     # 100 Milyon TL GÃ¼nlÃ¼k Hacim

    # --- 3. SMART MONEY (AkÄ±llÄ± Para) ---
    "SQUEEZE_THRESHOLD": 0.85,        # SÄ±kÄ±ÅŸma
    "DRYNESS_THRESHOLD": 0.80,        # Kuruma
    "STABILITY_THRESHOLD": 1.5,       # Stabilite

    # --- 4. AI (Machine Learning) ---
    "AI_HORIZON": 5,                  # 5 GÃ¼nlÃ¼k Tahmin
    "BACKTEST_DAYS": 120              # 6 AylÄ±k KanÄ±t SÃ¼resi
}

# HEDEF LÄ°STE (BIST 100 KarmasÄ±)
TICKERS = [
    "AEFES.IS", "AGHOL.IS", "AKBNK.IS", "AKSA.IS", "ALARK.IS", "ARCLK.IS",
    "ASELS.IS", "ASTOR.IS", "BIMAS.IS", "BRSAN.IS", "CCOLA.IS", "CIMSA.IS",
    "CWENE.IS", "DOAS.IS", "DOHOL.IS", "EGEEN.IS", "EKGYO.IS", "ENJSA.IS",
    "ENKAI.IS", "EREGL.IS", "EUPWR.IS", "FROTO.IS", "GARAN.IS", "GESAN.IS",
    "GUBRF.IS", "HALKB.IS", "HEKTS.IS", "ISCTR.IS", "ISMEN.IS", "KCHOL.IS",
    "KONTR.IS", "KOZAL.IS", "KRDMD.IS", "MGROS.IS", "MIATK.IS", "ODAS.IS",
    "OTKAR.IS", "OYAKC.IS", "PETKM.IS", "PGSUS.IS", "SAHOL.IS", "SASA.IS",
    "SISE.IS", "SOKM.IS", "TAVHL.IS", "TCELL.IS", "THYAO.IS", "TKFEN.IS",
    "TOASO.IS", "TSKB.IS", "TTKOM.IS", "TTRAK.IS", "TUPRS.IS", "ULKER.IS",
    "VAKBN.IS", "VESTL.IS", "YKBNK.IS", "YEOTK.IS", "XU100.IS"
]

# ============================================================
# ğŸ› ï¸ FEATURE ENGINEERING: SMART MONEY DEDEKTÃ–RÃœ
# ============================================================
def calculate_features(df):
    df = df.copy()

    # 1. Trend (EMA 20 - Optimize EdilmiÅŸ)
    df['EMA_Trend'] = df['Close'].ewm(span=CONFIG['EMA_TREND'], adjust=False).mean()
    df['Trend_Dist'] = (df['Close'] - df['EMA_Trend']) / df['EMA_Trend']

    # 2. Bollinger SÄ±kÄ±ÅŸmasÄ± (Squeeze)
    df['Mid'] = df['Close'].rolling(20).mean()
    df['Std'] = df['Close'].rolling(20).std()
    df['BB_Width'] = ((df['Mid'] + 2*df['Std']) - (df['Mid'] - 2*df['Std'])) / df['Mid']
    df['Squeeze_Idx'] = df['BB_Width'] / df['BB_Width'].rolling(120).mean()

    # 3. Hacim KurumasÄ± (Dryness)
    df['Vol_Dry_Idx'] = df['Volume'].rolling(5).mean() / df['Volume'].rolling(50).mean()

    # 4. Stabilite (KontrollÃ¼ SÃ¼zÃ¼lme)
    tr = pd.concat([df['High'] - df['Low'], (df['High'] - df['Close'].shift(1)).abs(), (df['Low'] - df['Close'].shift(1)).abs()], axis=1).max(axis=1)
    df['ATR'] = tr.ewm(span=14, adjust=False).mean()
    body_size = (df['Close'] - df['Open']).abs()
    df['Stability_Idx'] = body_size.rolling(10).mean() / df['ATR']

    # 5. Hacim Åiddeti (Intensity)
    df['Intensity'] = df['Volume'] / df['Volume'].rolling(50).mean()

    # 6. RSI (AI Girdisi)
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).ewm(alpha=1/14, adjust=False).mean()
    loss = (-delta.where(delta < 0, 0)).ewm(alpha=1/14, adjust=False).mean()
    df['RSI'] = 100 - (100 / (1 + (gain/loss)))

    return df.dropna()

# ============================================================
# ğŸ§  AI ENGINE: GELECEÄÄ° TAHMÄ°N ET
# ============================================================
def get_ai_prediction(df):
    """
    Optimize edilmiÅŸ parametrelerle eÄŸitilen Lojistik Regresyon.
    Hedef: Gelecek 5 gÃ¼nde %2 Ã¼zeri net getiri.
    """
    data = df.copy()

    # Target: 5 gÃ¼n sonra fiyat bugÃ¼nden %2 yÃ¼ksek mi?
    data['Target'] = (data['Close'].shift(-CONFIG['AI_HORIZON']) > data['Close'] * 1.02).astype(int)
    data = data.dropna()

    if len(data) < 150: return 50.0

    # Model Girdileri
    features = ['Squeeze_Idx', 'Vol_Dry_Idx', 'Stability_Idx', 'Trend_Dist', 'Intensity', 'RSI']
    X = data[features]
    y = data['Target']

    # Ã–lÃ§eklendirme
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)

    # EÄŸitim (Data Leakage'i Ã¶nlemek iÃ§in son 5 gÃ¼nÃ¼ hariÃ§ tut)
    model = LogisticRegression(class_weight='balanced', solver='liblinear', random_state=42)
    try:
        model.fit(X_scaled[:-5], y[:-5])
        # Tahmin
        current_features = X_scaled[-1].reshape(1, -1)
        prob = model.predict_proba(current_features)[0][1]
        return prob * 100
    except:
        return 50.0

# ============================================================
# ğŸ§ª BACKTEST ENGINE: KANIT SORGULA
# ============================================================
def run_optimized_backtest(df):
    """
    V12.1'de bulduÄŸumuz EN Ä°YÄ° parametreler (EMA 20, ATR 2.0) ile test eder.
    """
    data = df.tail(CONFIG['BACKTEST_DAYS']).copy()
    balance = 10000.0
    position = 0.0
    entry_price = 0.0
    highest_price = 0.0

    for i in range(len(data)):
        row = data.iloc[i]
        price = row['Close']

        # AL: Trend yukarÄ± + Stabil + Hacim var
        if position == 0:
            if row['Close'] > row['EMA_Trend'] and row['Intensity'] > 1.0:
                position = balance / price
                entry_price = price
                balance = 0
                highest_price = price

        # SAT: Trailing Stop (%5 Optimize EdilmiÅŸ)
        elif position > 0:
            if price > highest_price: highest_price = price

            stop_price = highest_price * (1 - CONFIG['TRAILING_PCT'])
            # Ekstra gÃ¼venlik: ATR Stop
            atr_stop = entry_price - (row['ATR'] * CONFIG['ATR_MULT'])

            final_stop = max(stop_price, atr_stop)

            if price < final_stop or price < row['EMA_Trend']:
                balance = position * price
                position = 0

    if position > 0: balance = position * data.iloc[-1]['Close']
    return (balance - 10000) / 10000 * 100
def send_telegram(msg):
    url = f"https://api.telegram.org/bot8396968001:AAEKIdyqNIEWMyGwbVzBonzlDF9kCd3D9DA/sendMessage"
    payload = {
        "chat_id": -5050366031,
         "text": f"<pre>{msg}</pre>",
         "parse_mode": "HTML"
         }
    requests.post(url, data=payload)

# ============================================================
# ğŸš€ TITAN PROD RUNNER
# ============================================================
def run_titan_prod():
    message = ""
    message += f"\nğŸ›ï¸  V13: TITAN PROD (OPTIMIZED) | {datetime.now().strftime('%d-%m-%Y')}"
    message += f"\nğŸ”¬  Parametreler: EMA-{CONFIG['EMA_TREND']} | Stop: ATR x {CONFIG['ATR_MULT']} | Trail: %{CONFIG['TRAILING_PCT']*100:.0f}"
    message += f"\nğŸ›¡ï¸  GÃ¼venlik: >50 Milyar TL Market Cap"
    message += "\nâ³ BÃ¼yÃ¼k veri iÅŸleniyor (AI Learning + Smart Money Analysis)..."

    raw_data = yf.download(TICKERS, period="2y", group_by='ticker', auto_adjust=False, progress=False)
    results = []

    for t in TICKERS:
        if t == "XU100.IS": continue

        try:
            # 1. MARKET CAP FÄ°LTRESÄ° (GÃ¼venlik)
            try:
                info = yf.Ticker(t).fast_info
                mcap = info['market_cap']
                if mcap < CONFIG['MIN_MARKET_CAP']: continue
            except: continue

            # 2. VERÄ° HAZIRLIÄI
            df = raw_data[t].copy().dropna()
            if len(df) < 200: continue

            df = calculate_features(df)
            last = df.iloc[-1]

            # Likidite Filtresi
            if last['Close'] * last['Volume'] < CONFIG['MIN_LIQUIDITY']: continue

            # Trend Filtresi (EMA 20 AltÄ± Yasak)
            if last['Close'] < last['EMA_Trend']: continue

            # 3. SMART MONEY PUANLAMA (Kalite Kontrol)
            sm_score = 0
            reasons = []

            if last['Squeeze_Idx'] < CONFIG['SQUEEZE_THRESHOLD']:
                sm_score += 1; reasons.append("SIKIÅMA")
            if last['Vol_Dry_Idx'] < CONFIG['DRYNESS_THRESHOLD']:
                sm_score += 1; reasons.append("KURUMA")
            if last['Stability_Idx'] < CONFIG['STABILITY_THRESHOLD']:
                sm_score += 1; reasons.append("STABÄ°L")
            if last['Intensity'] > 1.5:
                sm_score += 1; reasons.append("ğŸ”¥ HACÄ°M ÅOKU")

            # 4. AI & BACKTEST
            ai_prob = get_ai_prediction(df)
            roi = run_optimized_backtest(df)

            # 5. KAYIT
            results.append({
                "Hisse": t.replace(".IS",""),
                "Fiyat": last['Close'],
                "MCap_Mlr": mcap / 1e9,
                "SM_Kalite": sm_score,   # Max 4
                "AI_Prob": ai_prob,      # % OlasÄ±lÄ±k
                "ROI_Kanit": roi,        # % KanÄ±t
                "Etiketler": " + ".join(reasons) if reasons else "TREND TAKÄ°BÄ°",
                "Stop": last['Close'] - (last['ATR'] * CONFIG['ATR_MULT'])
            })

        except Exception as e: continue

    if not results:
        print("âŒ Kriterlere uygun hisse bulunamadÄ±.")
        return

    # SIRALAMA: (Smart Money Kalitesi > AI OlasÄ±lÄ±ÄŸÄ± > ROI KanÄ±tÄ±)
    df_res = pd.DataFrame(results).sort_values(["SM_Kalite", "AI_Prob"], ascending=[False, False])

    message += f"\nğŸ“Š TÄ°TAN PROD NÄ°HAÄ° LÄ°STE"
    message += f"\n{'HÄ°SSE':<6} {'FÄ°YAT':<9} {'SM_QLTY':<8} {'AI_PROB':<4} {'(SMART MONEY)':<32} {'STOP':<6}"

    for _, row in df_res.head(30).iterrows():
        # GÃ¶rselleÅŸtirmeler
        ai_str = f"%{row['AI_Prob']:.1f}"
        roi_str = f"%{row['ROI_Kanit']:.1f}"
        sm_bar = "â­" * int(row['SM_Kalite'])

        # Yapay Zeka Rengi (Konsolda metin olarak)
        if row['AI_Prob'] > 65: ai_tag = " (GÃœÃ‡LÃœ)"
        else: ai_tag = ""

        # ROI KanÄ±tÄ± KÃ¶tÃ¼yse Uyar
        if row['ROI_Kanit'] < 0: roi_str += " âš ï¸"
        message += (f"\n{row['Hisse']:<6} "f"{row['Fiyat']:<7.2f} "f"{sm_bar:<4} "f"{ai_str:<6} "f"{row['Etiketler'][:18]:<18} "f"{row['Stop']:<7.2f}")


    message += "\nâ„¹ï¸  SM_QLTY: â­â­â­â­ = SÄ±kÄ±ÅŸma + Kuruma + Stabilite + Hacim PatlamasÄ± (Nadir ve DeÄŸerli)."
    message += "\nâ„¹ï¸  AI_PROB: Yapay Zeka'nÄ±n bu teknik verilere dayanarak 'YÃ¼kseliÅŸ' tahmini."
    message += "\nâ„¹ï¸  ROI(KANIT): Bu strateji son 6 ayda bu hissede para kazandÄ±rdÄ± mÄ±?"
    send_telegram(message)

if __name__ == "__main__":
    run_titan_prod()